<!DOCTYPE html>
<html lang="bo">
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WQ62DL1S2M"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-WQ62DL1S2M');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TibetanKeys | Elemental Arena</title>
    <style>
        @font-face { font-family: 'OuChan2'; src: url('Monlam Uni OuChan2.ttf'); }
        body, html { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; background: #050505; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* Star Background */
        body { background-image: radial-gradient(white 1px, transparent 1px); background-size: 50px 50px; }

        .hud { position: absolute; top: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; z-index: 100; color: #fff; font-weight: bold; pointer-events: none; }
        .time-box { font-size: 40px; color: #00e676; text-shadow: 0 0 10px #00e676; }
        
        /* Leaderboard */
        .players-panel { display: flex; gap: 20px; }
        .p-score-box { background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px; border: 2px solid #333; text-align: center; }
        .p-name { font-size: 12px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }
        .p-val { font-size: 24px; }

        #game-canvas { display: block; width: 100%; height: 100%; }

        /* RESULT MODAL */
        #result-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; }
        .result-box { background: #111; padding: 50px; text-align: center; border-radius: 15px; border: 2px solid #444; width: 400px; }
        .res-title { font-size: 30px; font-weight: 900; color: #fff; margin-bottom: 20px; text-transform: uppercase; }
        .winner-txt { font-size: 18px; color: #ffd700; margin-bottom: 30px; }
        .res-btn { background: #00e676; color: #000; border: none; padding: 15px 40px; font-weight: bold; cursor: pointer; text-transform: uppercase; border-radius: 5px; }
        
        .back-btn { position: fixed; bottom: 20px; left: 20px; color: rgba(255,255,255,0.3); text-decoration: none; font-size: 12px; font-weight: bold; text-transform: uppercase; z-index: 200; }
    </style>
</head>
<body>

    <div class="hud">
        <div class="players-panel" id="score-panel">
            </div>
        <div class="time-box" id="game-timer">60</div>
    </div>

    <canvas id="game-canvas"></canvas>

    <div id="result-modal">
        <div class="result-box">
            <div class="res-title">Battle Over</div>
            <div class="winner-txt" id="winner-display">...</div>
            <button class="res-btn" onclick="window.location.href='multiplayer-lobby.html'">Return to Lobby</button>
        </div>
    </div>

    <a href="game-select.html" class="back-btn">← Exit</a>

    <script>
        // --- DATA ---
        const NORMAL_MAP = { 'k':'ཀ','t':'ཏ','p':'པ','s':'ས','d':'ད','f':'ང','g':'ག','h':'ཧ','j':'ཇ','l':'ལ','z':'ཟ','x':'ཙ','c':'ཅ','v':'ཌ','b':'བ','n':'ན','m':'མ','q':'ཊ','w':'ཝ','e':'ེ','r':'ར','y':'ཡ','u':'ུ','i':'ི','o':'ོ', '[':'༷',']':'྄','\\':'༔',';':'ཌྷ','\'':'འ',',':'ྱ','.':'ྲ','/':'།','`':'༌','1':'༡','2':'༢','3':'༣','4':'༤','5':'༥','6':'༦','7':'༧','8':'༨','9':'༩','0':'༠','-':'ྀ','=':'ཾ',' ':' ' };
        const SHIFT_MAP = { 'k':'ཁ','t':'ཐ','p':'ཕ','a':'ཨ','s':'ཤ','d':'ཛ','f':'དྷ','g':'གྷ','h':'ྷ','j':'ཛྷ','l':'ླ','z':'ཞ','x':'ཚ','c':'ཆ','v':'ཎ','b':'བྷ','n':'ཉ','m':'ཥ','q':'ཋ','w':'ྭ','e':'ཻ','r':'ཪ','y':'ྱ','u':'ཱུ','i':'ྀ','o':'ཽ', '[':'ྂ',']':'༵','\\':'྅',';':'ཿ','\'':'ཱ',',':'‚','.':'ླ','/':'„','`':'༸','1':'༑','2':'༄༅','3':'༅','4':'“','5':'”','6':'༈','7':'༼','8':'༽','9':'(','0':')','-':'ཱྀ','=':'ྃ',' ':' ' };

        // --- SETUP ---
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const socket = io();
        
        let active = true;
        let players = []; // [{id, name, score, color}]
        let enemies = [];
        let beams = []; // {sx, sy, tx, ty, color, life}

        // --- CANVAS ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
        window.addEventListener('resize', resize);
        resize();

        // --- JOIN ---
        socket.emit('join-room', roomId);

        // --- NETWORKING ---
        socket.on('spawn-enemy', (data) => {
            // Convert spawnType (0-4) to coordinates
            let x, y, vx, vy;
            const pad = 50;
            const speed = data.speed;

            if(data.spawnType === 4) { // Random Center Pop
                x = Math.random() * (width - 200) + 100;
                y = Math.random() * (height - 200) + 100;
                vx = (Math.random() - 0.5) * speed;
                vy = (Math.random() - 0.5) * speed;
            } else if (data.spawnType === 0) { // Top
                x = Math.random() * width; y = -pad; vx = (Math.random()-0.5)*speed; vy = speed;
            } else if (data.spawnType === 1) { // Right
                x = width + pad; y = Math.random() * height; vx = -speed; vy = (Math.random()-0.5)*speed;
            } else if (data.spawnType === 2) { // Bottom
                x = Math.random() * width; y = height + pad; vx = (Math.random()-0.5)*speed; vy = -speed;
            } else { // Left
                x = -pad; y = Math.random() * height; vx = speed; vy = (Math.random()-0.5)*speed;
            }

            enemies.push({
                id: data.id, char: data.char,
                x: x, y: y, vx: vx, vy: vy,
                life: 100 // Opacity/Life
            });
        });

        socket.on('enemy-destroyed', (data) => {
            // Find Enemy
            const eIdx = enemies.findIndex(e => e.id === data.enemyId);
            if(eIdx === -1) return;
            const target = enemies[eIdx];

            // Find Killer (to draw beam)
            const killer = players.find(p => p.id === data.killerId);
            if(killer && killer.pos) {
                // Add Beam
                beams.push({
                    sx: killer.pos.x, sy: killer.pos.y,
                    tx: target.x, ty: target.y,
                    color: killer.color,
                    life: 1.0
                });
            }

            // Remove Enemy
            enemies.splice(eIdx, 1);
        });

        socket.on('score-update', (serverPlayers) => {
            // Merge scores but keep positions
            serverPlayers.forEach(sp => {
                const local = players.find(p => p.id === sp.id);
                if(local) local.score = sp.score;
            });
            updateScoreUI();
        });

        socket.on('room-state', (room) => {
            // Initialize Players
            players = room.players;
            updateScoreUI();
        });

        socket.on('gametime-update', (t) => {
            document.getElementById('game-timer').innerText = t;
            if(t <= 10) document.getElementById('game-timer').style.color = '#ff4081';
        });

        socket.on('game-over', (finalPlayers) => {
            active = false;
            finalPlayers.sort((a,b) => b.score - a.score);
            const winner = finalPlayers[0];
            const isMe = winner.id === socket.id;
            
            let msg = isMe ? "VICTORY!" : winner.name + " WINS!";
            if(finalPlayers.length === 1) msg = "TRAINING COMPLETE";

            document.getElementById('winner-display').innerText = msg;
            document.getElementById('result-modal').style.display = 'flex';
        });

        function updateScoreUI() {
            const panel = document.getElementById('score-panel');
            panel.innerHTML = '';
            players.forEach(p => {
                const div = document.createElement('div');
                div.className = 'p-score-box';
                div.style.borderColor = p.color;
                div.innerHTML = `<div class="p-name" style="color:${p.color}">${p.name}</div><div class="p-val">${p.score}</div>`;
                panel.appendChild(div);
            });
        }

        // --- POSITION LOGIC ---
        function calculatePositions() {
            const count = players.length;
            const cx = width / 2;
            const cy = height / 2;
            const pad = 80;

            players.forEach((p, i) => {
                if (count === 1) {
                    p.pos = { x: cx, y: cy };
                } else if (count === 2) {
                    p.pos = { x: (i===0 ? pad : width-pad), y: cy };
                } else if (count === 3) {
                    if(i===0) p.pos = { x: cx, y: pad }; // Top
                    if(i===1) p.pos = { x: pad, y: height-pad }; // Bot Left
                    if(i===2) p.pos = { x: width-pad, y: height-pad }; // Bot Right
                } else { // 4 Players
                    if(i===0) p.pos = { x: pad, y: pad }; // Top Left
                    if(i===1) p.pos = { x: width-pad, y: pad }; // Top Right
                    if(i===2) p.pos = { x: pad, y: height-pad }; // Bot Left
                    if(i===3) p.pos = { x: width-pad, y: height-pad }; // Bot Right
                }
            });
        }

        // --- GAME LOOP ---
        function loop() {
            if (!active) return;
            
            // Clear
            ctx.fillStyle = 'rgba(5, 5, 5, 0.3)'; // Trail effect
            ctx.fillRect(0, 0, width, height);

            calculatePositions();

            // 1. Draw Players (Arrows)
            players.forEach(p => {
                if(!p.pos) return;
                
                // Draw Base
                ctx.shadowBlur = 20;
                ctx.shadowColor = p.color;
                ctx.fillStyle = '#111';
                ctx.beginPath();
                ctx.arc(p.pos.x, p.pos.y, 20, 0, Math.PI*2);
                ctx.fill();

                // Draw Arrow (Pointing to center or mouse? Let's point to center for idle look)
                // Or better: Just a cool elemental symbol
                ctx.strokeStyle = p.color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(p.pos.x - 10, p.pos.y + 10);
                ctx.lineTo(p.pos.x, p.pos.y - 15);
                ctx.lineTo(p.pos.x + 10, p.pos.y + 10);
                ctx.lineTo(p.pos.x, p.pos.y + 5); // Indent
                ctx.closePath();
                ctx.stroke();
                
                // Name
                ctx.fillStyle = p.color;
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(p.name, p.pos.x, p.pos.y + 35);
                ctx.shadowBlur = 0;
            });

            // 2. Draw Enemies
            ctx.font = 'bold 30px OuChan2';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            enemies.forEach((e, i) => {
                e.x += e.vx;
                e.y += e.vy;

                // Bounce off walls (Arena style)
                if(e.x < 0 || e.x > width) e.vx *= -1;
                if(e.y < 0 || e.y > height) e.vy *= -1;

                // Draw Glow
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#fff';
                ctx.fillStyle = 'rgba(255,255,255,0.9)';
                ctx.fillText(e.char, e.x, e.y);
                ctx.shadowBlur = 0;
            });

            // 3. Draw Beams
            for (let i = beams.length - 1; i >= 0; i--) {
                let b = beams[i];
                ctx.beginPath();
                ctx.strokeStyle = b.color;
                ctx.lineWidth = b.life * 5;
                ctx.globalAlpha = b.life;
                ctx.moveTo(b.sx, b.sy);
                ctx.lineTo(b.tx, b.ty);
                ctx.stroke();
                ctx.globalAlpha = 1;
                
                b.life -= 0.1;
                if(b.life <= 0) beams.splice(i, 1);
            }

            requestAnimationFrame(loop);
        }

        // --- INPUT ---
        window.addEventListener('keydown', (e) => {
            if (!active) return;
            const physicalKey = e.key.toLowerCase();
            let typedChar = (e.shiftKey ? SHIFT_MAP[physicalKey] : NORMAL_MAP[physicalKey]) || "";
            if (e.code === "Space") typedChar = " ";

            // Find Enemy
            const target = enemies.find(en => en.char === typedChar);
            
            if (target) {
                // Send Hit to Server
                socket.emit('enemy-killed', { roomId: roomId, enemyId: target.id });
                socket.emit('player-score', { roomId: roomId, points: 10 });
            }
        });

        requestAnimationFrame(loop);

    </script>
</body>
</html>